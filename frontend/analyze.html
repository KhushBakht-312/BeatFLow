<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analyze</title>
  <link rel="stylesheet" href="./style.css">
  <link rel="icon" href="./images/heart.png" type="image/png">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="bg-media2">
  <img src="images/Final_bd.gif">
</div>
<header>
  <div class="navbar" style="opacity:0.9;">
    <div class="logo">
      <img src="/images/heart.png" alt="Logo">
      <span style="font-family:'Satisfy', cursive;">BeatFlow</span>
    </div>
    <nav>
      <a href="/">Home</a>
      <a href="/analyze" class="active">Analyze</a>
      <a href="/about">About</a>
    </nav>
  </div>
</header>

<section class="analyze">
  <div class="analyze-container">

    <div class="analyze-text">
      <h1 style="background-color: rgb(255, 244, 244); width: 51%; opacity: 90%; border-radius: 20px;">Analyze Your Heartbeat</h1>
      <p>Get instant AI-powered insights through BeatFlow.<br>Monitor your heartbeat health.</p>
      <div class="hint-card">
         Use clearer ECG Image for higher precision!
      </div>
    </div>

    <div class="analyze-section">
      
      <div class="analyze-gif">
        <img src="/images/heatt.gif" alt="ECG Animation">
      </div>

      
      <div class="analyze-box">
        <h4>Upload your ECG Image</h4><br>
        <label class="custom-file-upload">
          <input type="file" id="ecgImage" accept="image/*">
          EKG Image
        </label>

        <button onclick="analyzeImage()">Analyze Image</button>

        <div class="loader" id="imgLoader">Analyzing ECG Image...</div>
        <br>

        <div class="result-box" id="imgResult" style="display:none;">
          <div id="reportDiv">
            <p><strong>Status:</strong> <span id="imgStatus">--</span></p>
            <p><strong>Confidence:</strong> <span id="imgConf">--</span>%</p>
            <p><strong>Insights:</strong> <span id="imgInsight">--</span></p>
            <img id="imgPreview" style="max-width: 200px; display:block; margin-top:10px;">
          </div>
          <button class="download-btn" onclick="downloadResult('reportDiv', 'ECG_Report')">Download Result</button>
        </div>

        <br>

        <div class="possibilities-box" id="possibilitiesBox" style="display:none"></div>
      </div>

      
      <div class="image-preview-container">
        <div class="timeline" id="timeline" style="display:none">
          <ul>
            <li>Image uploaded</li>
            <li>Preprocessing applied</li>
            <li>Feature extraction</li>
            <li>CNN classification</li>
            <li>Result generated</li>
          </ul>
        </div>
      </div>
    </div>

    <div class="system-notes">
      <h4>Your History</h4>
      <div id="historyBox"></div>
    </div>

  </div>
</section>

<script>
let historyList = [];

function analyzeImage() {
  const img = document.getElementById("ecgImage").files[0];
  if (!img) {
    alert("Please upload an ECG image.");
    return;
  }

  document.getElementById("imgResult").style.display = "none";
  document.getElementById("imgLoader").style.display = "block";

  /* ─── TIMELINE ─── */
  const timeline = document.getElementById("timeline");
  timeline.style.display = "block";

  const steps = timeline.querySelectorAll("li");
  steps.forEach(step => step.style.opacity = 0);
  steps.forEach((step, index) => {
    setTimeout(() => step.style.opacity = 1, 500 * (index + 1));
  });

  const formData = new FormData();
  formData.append("image", img);

  fetch("/analyze", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      document.getElementById("imgLoader").style.display = "none";
      if (data.error) return alert(data.error);

      document.getElementById("imgResult").style.display = "block";

      const statusEl = document.getElementById("imgStatus");
      const confEl = document.getElementById("imgConf");
      const insightEl = document.getElementById("imgInsight");
      const preview = document.getElementById("imgPreview");
      const possBox = document.getElementById("possibilitiesBox");

      statusEl.innerText = data.image_status || "--";
      confEl.innerText = data.confidence_image || "--";
      insightEl.innerText = data.insight_image || "--";

      if (data.image_status === "Healthy") statusEl.style.color = "green";
      else if (data.image_status === "Unhealthy") statusEl.style.color = "red";
      else {
        statusEl.style.color = "#f59e0b";
        confEl.innerText = "--";
      }

      if (data.possibilities && data.possibilities.length && data.image_status !== "Invalid") {
        possBox.style.display = "block";
        possBox.innerHTML = "<strong>Possible conditions:</strong> " + data.possibilities.join(", ");
      } else possBox.style.display = "none";

      if (data.image_url) {
        preview.src = data.image_url;
        preview.style.display = "block";
      }

      historyList.unshift({
        file: img.name,
        status: data.image_status,
        confidence: data.confidence_image,
        insight: data.insight_image,
        possibilities: data.possibilities || [],
        image_url: data.image_url,
        time: new Date().toLocaleString()
      });

      renderHistoryTable();
    })
    .catch(() => {
      document.getElementById("imgLoader").style.display = "none";
      alert("Backend is not running.");
    });
}


function renderHistoryTable() {
  let html = `
    <table class="history-table">
      <tr>
        <th>File</th>
        <th>Status</th>
        <th>Confidence</th>
        <th>Action</th>
      </tr>
  `;

  historyList.slice(0, 3).forEach((h, i) => {
    const valid = h.status === "Healthy" || h.status === "Unhealthy";
    html += `
      <tr>
        <td>${h.file}</td>
        <td>${h.status}</td>
        <td>${valid ? h.confidence + "%" : "--"}</td>
        <td>
          ${valid ? `<button class="download-btn" onclick="downloadHistoryReport(${i})">Download</button>` : "—"}
        </td>
      </tr>
    `;
  });

  html += "</table>";
  document.getElementById("historyBox").innerHTML = html;
}

/* ─── DOWNLOAD REPORT (WITH LOGO + DATE + WATERMARK) ─── */
function downloadHistoryReport(index) {
  const h = historyList[index];
  if (!h) return;

  const report = document.createElement("div");
  report.style.width = "700px";
  report.style.padding = "30px";
  report.style.background = "#fff";
  report.style.color = "#000";
  report.style.fontFamily = "Arial, sans-serif";
  report.style.position = "relative";

  report.innerHTML = `
    <div style="display:flex; align-items:center; gap:12px;">
      <img src="/images/heart.png" width="40">
      <h2 style="margin:0;">BeatFlow ECG Report</h2>
    </div>

    <p style="margin-top:10px; font-size:13px;">
      Generated on: ${h.time}
    </p>

    <hr>

    <p><strong>File:</strong> ${h.file}</p>
    <p><strong>Status:</strong> ${h.status}</p>
    <p><strong>Confidence:</strong> ${h.confidence}%</p>
    <p><strong>Insight:</strong> ${h.insight}</p>

    ${
      h.possibilities.length
        ? `<p><strong>Possible Conditions:</strong> ${h.possibilities.join(", ")}</p>`
        : ""
    }

    ${
      h.image_url
        ? `<img src="${h.image_url}" style="max-width:100%; margin-top:20px;">`
        : ""
    }

    <div style="
      position:absolute;
      bottom:20px;
      right:20px;
      opacity:0.08;
      font-size:48px;
      transform:rotate(-15deg);
    ">
      BeatFlow
    </div>
  `;

  document.body.appendChild(report);

  html2canvas(report).then(canvas => {
    const link = document.createElement("a");
    link.href = canvas.toDataURL("image/png");
    link.download = h.file.replace(/\.[^/.]+$/, "") + "_BeatFlow_Report.png";
    link.click();
    document.body.removeChild(report);
  });
}
</script>

<footer> &copy; 2026 BeatFlow - All rights reserved</footer>
</body>
</html>